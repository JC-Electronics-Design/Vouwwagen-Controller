<!--
  Jonathan Caes

  This html page controls the vouwwagen controller via Bluetooth Low Energy
-->

<!DOCTYPE html>
<html>
<head>
    <title>Vouwwagen Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Vouwwagen Controller</h1>
    <button id="connectBleButton">Connect to BLE Device</button>
    <button id="disconnectBleButton">Disconnect BLE Device</button>
    <p>BLE state: <strong><span id="bleState" style="color:#d13a30;">Disconnected</span></strong></p>
    <h2>Relay Control</h2>
    <!-- Rounded switch -->
    <p>Relay 1
    <label class="switch"> 
    <input type="checkbox" id="relay_1">
    <span class="slider round"></span>
    </label></p>
    <p>Relay 2
    <label class="switch"> 
    <input type="checkbox" id="relay_2">
    <span class="slider round"></span>
    </label></p>
    <p>Relay 3
    <label class="switch"> 
    <input type="checkbox" id="relay_3">
    <span class="slider round"></span>
    </label></p>
    <p>Relay 4
    <label class="switch"> 
    <input type="checkbox" id="relay_4">
    <span class="slider round"></span>
    </label></p>

    <h2>LED Control</h2>
    <p>LED String 1
    <label id="led_string_1" class="switch"> 
    <input type="checkbox">
    <span class="slider round"></span>
    </label></p>
    <label for="favcolor">Select color</label>
    <input type="color" id="favcolor" name="favcolor" value="#00FFFF">
</body>
<script>
    // DOM Elements
    const connectButton = document.getElementById('connectBleButton');
    const disconnectButton = document.getElementById('disconnectBleButton');
    const bleStateContainer = document.getElementById('bleState');

    const relay1_switch = document.getElementById('relay_1');
    const relay2_switch = document.getElementById('relay_2');
    const relay3_switch = document.getElementById('relay_3');
    const relay4_switch = document.getElementById('relay_4');
    const led_string1_switch = document.getElementById('led_string_1');

    //Define BLE Device Specs
    var deviceName = 'VW-Controller';
    var bleService = '8c113600-3ec3-452c-868c-7d6b5a3afe1c';
    var relay_1_characteristic = '8c113601-3ec3-452c-868c-7d6b5a3afe1c';
    var relay_2_characteristic = '8c113602-3ec3-452c-868c-7d6b5a3afe1c';
    var relay_3_characteristic = '8c113603-3ec3-452c-868c-7d6b5a3afe1c';
    var relay_4_characteristic = '8c113604-3ec3-452c-868c-7d6b5a3afe1c';

    //Global Variables to Handle Bluetooth
    var bleServer;
    var bleServiceFound;
    var sensorCharacteristicFound;

    // Connect Button (search for BLE Devices only if BLE is available)
    connectButton.addEventListener('click', (event) => {
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });

    // Disconnect Button
    disconnectButton.addEventListener('click', disconnectDevice);

    // Add event listeners for relay objects
    relay1_switch.addEventListener('click', () => writeOnCharacteristic(relay_1_characteristic, relay1_switch.checked));
    relay2_switch.addEventListener('click', () => writeOnCharacteristic(relay_2_characteristic, relay2_switch.checked));
    relay3_switch.addEventListener('click', () => writeOnCharacteristic(relay_3_characteristic, relay3_switch.checked));
    relay4_switch.addEventListener('click', () => writeOnCharacteristic(relay_4_characteristic, relay4_switch.checked));


    // Check if BLE is available in your Browser
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
            console.log("Web Bluetooth API is not available in this browser!");
            bleStateContainer.innerHTML = "Web Bluetooth API is not available in this browser!";
            return false
        }
        console.log('Web Bluetooth API supported in this browser.');
        return true
    }

    function subscribeAndRead(characteristic, handler) {
        return characteristic.readValue().then(value => {
            // Simulate a notification event for the initial read
            handler({ target: { value } });

            // Then subscribe to future notifications
            return characteristic.startNotifications().then(() => {
            characteristic.addEventListener('characteristicvaluechanged', handler);
            console.log("Subscribed to:", characteristic.uuid);
            });
        });
    }

    // Connect to BLE Device and Enable Notifications
    function connectToDevice(){
        console.log('Initializing Bluetooth...');
        navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [bleService]
        })
        .then(device => {
            console.log('Device Selected:', device.name);
            bleStateContainer.innerHTML = 'Connected to device ' + device.name;
            bleStateContainer.style.color = "#24af37";
            device.addEventListener('gattservicedisconnected', onDisconnected);
            return device.gatt.connect();
        })
        .then(gattServer =>{
            bleServer = gattServer;
            console.log("Connected to GATT Server");
            return bleServer.getPrimaryService(bleService);
        })
        .then(service => {
            bleServiceFound = service;
            console.log("Service discovered:", service.uuid);
            return Promise.all([
                service.getCharacteristic(relay_1_characteristic),
                service.getCharacteristic(relay_2_characteristic),
                service.getCharacteristic(relay_3_characteristic),
                service.getCharacteristic(relay_4_characteristic)
            ]);
        })
        .then(([relay1, relay2, relay3, relay4]) => {
            console.log("All characteristics discovered");

            return Promise.all([
                subscribeAndRead(relay1, handleRelay1Update),
                subscribeAndRead(relay2, handleRelay2Update),
                subscribeAndRead(relay3, handleRelay3Update),
                subscribeAndRead(relay4, handleRelay4Update),
            ])
        })
        .catch(error => {
            console.log('Error: ', error);
        })
    }

    function onDisconnected(event) {
        console.log('Device Disconnected:', event.target.device.name);
        bleStateContainer.innerHTML = "Device disconnected";
        bleStateContainer.style.color = "#d13a30";

        connectToDevice();
    }

    function disconnectDevice() {
        console.log("Disconnect Device.");
        if(bleServer && bleServer.connected) {
            console.log("Device Disconnected");
            bleStateContainer.innerHTML = "Device Disconnected";
            bleStateContainer.style.color = "#d13a30";
            return bleServer.disconnect();
        } else {
            // Throw an error if Bluetooth is not connected
            console.error("Bluetooth is not connected.");
            window.alert("Bluetooth is not connected.")
        }
    }

    // Relay event handlers
    function handleRelay1Update(event) {
        const value = event.target.value.getUint8(0);
        console.log("Relay 1:", value);
        relay1_switch.checked = value;
    }
    function handleRelay2Update(event) {
        const value = event.target.value.getUint8(0);
        console.log("Relay 2:", value);
        relay2_switch.checked = value;
    }
    function handleRelay3Update(event) {
        const value = event.target.value.getUint8(0);
        console.log("Relay 3:", value);
        relay3_switch.checked = value;
    }
    function handleRelay4Update(event) {
        const value = event.target.value.getUint8(0);
        console.log("Relay 4:", value);
        relay4_switch.checked = value;
    }

    function writeOnCharacteristic(uuid, value){
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(uuid)
            .then(characteristic => {
                console.log("Found the characteristic: ", characteristic.uuid);
                if(value) {
                    console.log(true);
                } else if(!value) {
                    console.log(false);
                }
                const data = new Uint8Array([value]);
                return characteristic.writeValue(data);
            })
            .catch(error => {
                console.error("Error writing to the characteristic: ", error);
            });
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
    }



</script>

</html>